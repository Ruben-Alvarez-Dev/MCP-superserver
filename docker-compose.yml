# ============================================================
# MCP-SUPERSERVER - Main Docker Compose Configuration
# ============================================================
# This orchestrates all services for the unified AI hub
#
# Services:
#   - neo4j: Graph database for structured memory
#   - ollama: Local LLM inference with model mesh
#   - mcp-hub: Wanaku router with all MCP servers
#   - backup-scheduler: Automated backups
#   - monitoring: Prometheus metrics
#
# Usage:
#   make start      # Start all services
#   make stop       # Stop all services
#   make status     # Show service status
# ============================================================

version: '3.9'

services:
  # ============================================================
  # NEO4J - Graph Database (Structured Memory)
  # ============================================================
  neo4j:
    build:
      context: ./Docker/neo4j-custom
      dockerfile: Dockerfile
    image: mcp-superserver/neo4j:latest
    container_name: mcp-neo4j
    ports:
      - "${NEO4J_PORT_BOLT:-7687}:7687"   # Bolt protocol
      - "${NEO4J_PORT_HTTP:-7474}:7474"   # HTTP UI
    environment:
      - NEO4J_AUTH=${NEO4J_AUTH:-neo4j/change_me_in_production}
      - NEO4J_PLUGINS=["apoc"]
      - NEO4J_dbms_memory_heap_initial__size=${NEO4J_dbms_memory_heap_initial__size:-512m}
      - NEO4J_dbms_memory_heap_max__size=${NEO4J_dbms_memory_heap_max__size:-2G}
      - NEO4J_dbms_memory_pagecache_size=1g
    volumes:
      - ./data/neo4j/data:/data
      - ./data/neo4j/plugins:/plugins
      - ./data/neo4j/conf:/conf
    networks:
      - mcp-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "cypher-shell", "-u", "neo4j", "-p", "change_me_in_production", "RETURN 1"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s

  # ============================================================
  # OLLAMA - Local LLM Inference (Model Mesh)
  # ============================================================
  ollama:
    build:
      context: ./Docker/ollama-custom
      dockerfile: Dockerfile
    image: mcp-superserver/ollama:latest
    container_name: mcp-ollama
    ports:
      - "${OLLAMA_PORT:-11434}:11434"
    environment:
      - OLLAMA_MODELS=${OLLAMA_MODELS:-llama3.3,qwq,codellama}
    volumes:
      - ./data/ollama/models:/root/.ollama/models
    networks:
      - mcp-network
    restart: unless-stopped
    deploy:
      resources:
        reservations:
          devices:
            - driver: ${OLLAMA_GPU_DRIVER:-nvidia}
              count: 1
              capabilities: [gpu]
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:11434/api/tags"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  # ============================================================
  # OBSIDIAN VAULT - Logs & Documentation (Volume Mount)
  # ============================================================
  obsidian-vault:
    image: alpine:latest
    container_name: mcp-obsidian-vault
    volumes:
      - ./data/obsidian:/vault:rw
      - obsidian-data:/vault_data
    networks:
      - mcp-network
    command: tail -f /dev/null
    restart: unless-stopped

  # ============================================================
  # MCP HUB - Wanaku Router + All MCP Servers
  # ============================================================
  mcp-hub:
    build:
      context: ./Docker/mcp-hub
      dockerfile: Dockerfile
      args:
        - NEO4J_URI=${NEO4J_URI:-bolt://neo4j:7687}
        - OLLAMA_HOST=${OLLAMA_HOST:-ollama}
        - OLLAMA_PORT=${OLLAMA_PORT:-11434}
    image: mcp-superserver/mcp-hub:latest
    container_name: mcp-hub
    ports:
      - "${MCP_HUB_PORT:-3000}:3000"
    environment:
      # Neo4j Connection
      - NEO4J_URI=bolt://neo4j:7687
      - NEO4J_USER=neo4j
      - NEO4J_PASSWORD=${NEO4J_PASSWORD:-change_me_in_production}

      # Ollama Connection
      - OLLAMA_HOST=ollama
      - OLLAMA_PORT=11434
      - OLLAMA_MODELS=${OLLAMA_MODELS:-llama3.3,qwq,codellama}

      # Obsidian Vault
      - OBSIDIAN_VAULT=/vault

      # Logging
      - LOG_LEVEL=${LOG_LEVEL:-info}
      - LOG_FORMAT=${LOG_FORMAT:-json}

      # Middleware
      - ENABLE_MIDDLEWARE=true
      - ENABLE_OBSERVABILITY=true
      - ENABLE_AUTO_LOGGING=true

      # Protocol Omega
      - PROTOCOL_OMEGA_ENABLED=${PROTOCOL_OMEGA_ENABLED:-true}
      - PROTOCOL_OMEGA_ENFORCE=${PROTOCOL_OMEGA_ENFORCE:-true}
    volumes:
      - ./config/mcp-hub.json:/app/config/mcp-hub.json:ro
      - ./config/protocol-omega.md:/app/config/protocol-omega.md:ro
      - ./data/obsidian:/vault:rw
      - ./logs:/app/logs
    networks:
      - mcp-network
    depends_on:
      neo4j:
        condition: service_healthy
      ollama:
        condition: service_healthy
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/health"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s

  # ============================================================
  # BACKUP SCHEDULER - Automated Backups
  # ============================================================
  backup-scheduler:
    image: alpine:latest
    container_name: mcp-backup-scheduler
    volumes:
      - ./scripts/backup:/scripts:ro
      - ./data:/data:ro
      - ./exports:/exports
    environment:
      - BACKUP_SCHEDULE=${BACKUP_SCHEDULE:-0 2 * * *}
      - BACKUP_RETENTION_DAYS=${BACKUP_RETENTION_DAYS:-7}
      - BACKUP_COMPRESSION=${BACKUP_COMPRESSION:-true}
      - TZ=${TZ:-UTC}
    networks:
      - mcp-network
    command: /scripts/schedule-backup.sh
    restart: unless-stopped

  # ============================================================
  # MONITORING - Prometheus Metrics
  # ============================================================
  monitoring:
    image: prom/prometheus:latest
    container_name: mcp-monitoring
    ports:
      - "${PROMETHEUS_PORT:-9090}:9090"
    volumes:
      - ./config/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - prometheus-data:/prometheus
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--web.console.libraries=/etc/prometheus/console_libraries'
      - '--web.console.templates=/etc/prometheus/consoles'
      - '--storage.tsdb.retention.time=${PROMETHEUS_RETENTION:-15d}'
    networks:
      - mcp-network
    restart: unless-stopped

networks:
  mcp-network:
    driver: bridge
    name: mcp-network
    ipam:
      config:
        - subnet: 172.28.0.0/16
          gateway: 172.28.0.1

volumes:
  obsidian-data:
    driver: local
    name: mcp-obsidian-data
  prometheus-data:
    driver: local
    name: mcp-prometheus-data
